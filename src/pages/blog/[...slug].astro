---
import { getEntry } from 'astro:content';
import BlogPost from '../../layouts/BlogPost.astro';

// Get the slug from the URL (it's a catch-all route, so join if array)
const slugParam = Astro.params.slug;
const slug = Array.isArray(slugParam) ? slugParam.join('/') : slugParam;

// Fetch the post dynamically (SSR mode)
const post = await getEntry('blog', slug as string);

// 404 if post doesn't exist
if (!post) {
  return Astro.redirect('/404');
}

// Check if post is published (unless preview mode via query param)
const isPreview = Astro.url.searchParams.get('preview') === 'true';
if (!isPreview) {
  const runtime = Astro.locals.runtime;
  const db = runtime?.env?.DB;

  if (db) {
    try {
      const result = await db
        .prepare('SELECT published FROM post_status WHERE post_slug = ?')
        .bind(post.slug)
        .first();

      // If post is not in DB or not published, 404
      if (!result || result.published !== 1) {
        return Astro.redirect('/404');
      }
    } catch (e) {
      console.error('Failed to check post publish status:', e);
      // Allow post to render if DB check fails (graceful degradation)
    }
  }
}

const { Content } = await post.render();
---

<BlogPost {...post.data} slug={post.slug}>
  <Content />
</BlogPost>
