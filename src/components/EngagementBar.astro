---
interface Props {
  postSlug: string;
}

const { postSlug } = Astro.props;
---

<div class="engagement-bar flex items-center gap-6 py-4 border-y border-border my-8">
  <!-- Like Button -->
  <button
    id="like-button"
    data-post-slug={postSlug}
    class="group flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-card-bg transition-all duration-200"
    aria-label="Like this post"
  >
    <svg
      class="heart-icon w-6 h-6 transition-all duration-200"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
      ></path>
    </svg>
    <span id="like-count" class="font-medium">0</span>
  </button>

  <!-- Comment Button -->
  <button
    id="comment-button"
    class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-card-bg transition-all duration-200"
    aria-label="Jump to comments"
  >
    <svg
      class="w-6 h-6"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
      ></path>
    </svg>
    <span id="comment-count" class="font-medium">0</span>
  </button>
</div>

<script>
  import { actions } from 'astro:actions';

  const likeButton = document.getElementById('like-button') as HTMLButtonElement;
  const likeCount = document.getElementById('like-count');
  const heartIcon = document.querySelector('.heart-icon') as SVGElement;
  const commentButton = document.getElementById('comment-button') as HTMLButtonElement;
  const commentCount = document.getElementById('comment-count');

  if (likeButton && likeCount && heartIcon) {
    const postSlug = likeButton.dataset.postSlug;
    if (!postSlug) {
      console.error('No post slug found');
    } else {
      let isLiked = false;
      let isAnimating = false;

      // Load initial like status
      async function loadLikes() {
        try {
          const result = await actions.getLikes({ postSlug: postSlug! });
          if (result.data && likeCount) {
            isLiked = result.data.liked;
            likeCount.textContent = result.data.count.toString();
            updateHeartIcon();
          }
        } catch (error) {
          console.error('Error loading likes:', error);
          if (likeCount) likeCount.textContent = '0'; // Fallback to 0 instead of NaN
        }
      }

      // Toggle like
      async function toggleLike() {
        if (isAnimating) return;
        
        isAnimating = true;
        likeButton.disabled = true;

        // Optimistic update
        const currentCount = parseInt(likeCount?.textContent || '0') || 0;
        if (likeCount) {
          isLiked = !isLiked;
          likeCount.textContent = (currentCount + (isLiked ? 1 : -1)).toString();
          updateHeartIcon();
        }

        // Animate
        if (isLiked) {
          heartIcon.style.animation = 'heartBeat 0.3s ease-in-out';
          setTimeout(() => {
            heartIcon.style.animation = '';
          }, 300);
        }

        try {
          const result = await actions.toggleLike({ postSlug: postSlug! });
          
          if (result.data && likeCount) {
            // Update with actual count from server
            isLiked = result.data.liked;
            likeCount.textContent = result.data.count.toString();
            updateHeartIcon();
          } else if (result.error && likeCount) {
            // Revert on error
            isLiked = !isLiked;
            likeCount.textContent = currentCount.toString();
            updateHeartIcon();
            console.error('Error:', result.error);
          }
        } catch (error) {
          console.error('Error toggling like:', error);
          // Revert on error
          if (likeCount) {
            isLiked = !isLiked;
            likeCount.textContent = currentCount.toString();
            updateHeartIcon();
          }
        } finally {
          isAnimating = false;
          likeButton.disabled = false;
        }
      }

      function updateHeartIcon() {
        if (isLiked) {
          heartIcon.style.fill = 'currentColor';
          heartIcon.style.color = '#ef4444'; // red-500
        } else {
          heartIcon.style.fill = 'none';
          heartIcon.style.color = '';
        }
      }

      // Event listeners
      likeButton.addEventListener('click', toggleLike);

      // Load initial state
      loadLikes();
    }
  }

  // Load comment count
  if (commentButton && commentCount) {
    const postSlug = likeButton?.dataset.postSlug;
    if (postSlug) {
      async function loadCommentCount() {
        try {
          const result = await actions.getComments({ postSlug: postSlug! });
          if (result.data && commentCount) {
            commentCount.textContent = result.data.count.toString();
          }
        } catch (error) {
          console.error('Error loading comment count:', error);
          if (commentCount) commentCount.textContent = '0'; // Fallback to 0 instead of NaN
        }
      }

      // Open comments sidebar on click
      commentButton.addEventListener('click', () => {
        window.dispatchEvent(new Event('open-comments-sidebar'));
      });
      
      // Listen for comments loaded event
      window.addEventListener('comments-loaded', (e: any) => {
        if (e.detail && commentCount) {
          commentCount.textContent = e.detail.count.toString();
        }
      });

      loadCommentCount();

      // Listen for new comments to update count
      window.addEventListener('comment-posted', () => {
        loadCommentCount();
      });
    }
  }
</script>

<style>
  @keyframes heartBeat {
    0% {
      transform: scale(1);
    }
    25% {
      transform: scale(1.3);
    }
    50% {
      transform: scale(1.1);
    }
    75% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
    }
  }

  .engagement-bar button:hover .heart-icon {
    color: #ef4444;
  }

  .engagement-bar button:active {
    transform: scale(0.95);
  }
</style>

